# Работа с базой данных и миграциями

В этом проекте для управления миграциями базы данных используется [Alembic](https://alembic.sqlalchemy.org/en/latest/). Управление зависимостями осуществляется через `uv`.

## Предварительные требования

Убедитесь, что у вас установлен `uv`. Все команды выполняются через `uv run`, чтобы гарантировать использование правильного виртуального окружения.

## Основной рабочий процесс

### Создание миграции

После внесения изменений в модели SQLAlchemy (в `app/db/models/`), создайте новую ревизию миграции:

```bash
uv run alembic revision --autogenerate -m "описание изменений"
```

Флаг `--autogenerate` автоматически обнаружит изменения в моделях и сгенерирует соответствующий скрипт миграции. Всегда проверяйте сгенерированный файл в `app/db/migrations/versions/` перед применением.

### Применение миграций

Чтобы применить все ожидающие миграции и обновить базу данных до актуального состояния:

```bash
uv run alembic upgrade head
```

### Откат миграций

Если необходимо отменить последнюю миграцию:

```bash
uv run alembic downgrade -1
```

Чтобы откатить все миграции (вернуться к пустой базе):

```bash
uv run alembic downgrade base
```

## Миграции перечислений (Enums)

Проект использует библиотеку `alembic-postgresql-enum` для улучшения поддержки PostgreSQL ENUM типов в Alembic. Это позволяет автоматически обрабатывать изменения в классах `Enum` (добавление или переименование значений) без необходимости писать SQL вручную.

### Как это работает

1.  Внесите изменения в ваш Python `Enum` класс (например, добавьте новое значение).
2.  Запустите стандартную команду создания миграции:

    ```bash
    uv run alembic revision --autogenerate -m "update enum values"
    ```

3.  `alembic-postgresql-enum` автоматически обнаружит изменения в значениях перечисления и сгенерирует необходимые `ALTER TYPE ... ADD VALUE` инструкции в файле миграции.

Это значительно упрощает поддержку перечислений в PostgreSQL, делая процесс полностью автоматическим.
