# Trigger Bot

Telegram-бот для управления пользовательскими триггерами в чатах. Позволяет пользователям задавать ключевые фразы и соответствующие ответы (текст, изображения, стикеры и т.д.).

## Возможности

*   **Создание триггеров**: Настройка триггеров с текстом, фото, стикерами, анимацией и т.д.
*   **Типы совпадений**: Точное совпадение, Содержит, Регулярное выражение.
*   **Контроль доступа**: Настройка того, кто может добавлять триггеры (все или только администраторы).
*   **Управление**: Список, удаление и управление триггерами через команды и инлайн-интерфейс.
*   **Интернационализация**: Поддержка нескольких языков (Английский, Русский).
*   **Кэширование**: Высокая производительность благодаря кэшированию Valkey (Redis).

## Установка

### Требования

*   Установленные Docker и Docker Compose.
*   Токен Telegram-бота (от @BotFather).

### Инструкция по установке

1.  **Клонируйте репозиторий:**
    ```bash
    git clone <repository_url>
    cd trigger
    ```

2.  **Переменные окружения:**
    Вы можете задать переменные окружения в файле `.env` или напрямую в `docker-compose.yml`.

    | Variable | Required | Default | Description |
    | :--- | :---: | :--- | :--- |
    | `BOT_TOKEN` | Yes | - | Токен Telegram-бота |
    | `MODERATION_CHANNEL_ID` | Yes | - | ID чата для уведомлений модерации |
    | `WEBHOOK_URL` | Yes | - | Полный URL для вебхука |
    | `WEBHOOK_PATH` | Yes | - | Путь для вебхука (например, `/webhook`) |
    | `SECRET_TOKEN` | Yes | - | Секретный токен для защиты вебхука |
    | `POSTGRES_URL` | No | - | Строка подключения к PostgreSQL (в Docker собирается автоматически) |
    | `VALKEY_URL` | No | `redis://valkey:6379/0` | Строка подключения к Valkey (Redis) |
    | `RABBITMQ_URL` | No | `amqp://guest:guest@rabbitmq:5672/` | Строка подключения к RabbitMQ |
    | `TELEGRAM_BOT_API_URL` | No | - | URL локального сервера Bot API |
    | `OLLAMA_BASE_URL` | No | `http://localhost:11434` | URL сервера Ollama |
    | `OLLAMA_VISION_MODEL` | No | `qwen3-vl:8b` | Модель Ollama для изображений |
    | `OLLAMA_TEXT_MODEL` | No | `aya-expanse:8b` | Модель Ollama для текста |
    | `ROUTER_NAME` | No | `bot` | Имя роутера Traefik |
    | `PROXY_PORT` | No | `8080` | Порт прокси Traefik |

3.  **Запустите сервисы:**
    ```bash
    docker-compose up -d --build
    ```

4.  **Запустите миграции базы данных:**
    Примените схему базы данных:
    ```bash
    docker-compose exec bot alembic upgrade head
    ```

### Настройка Ollama для модерации

Для работы системы модерации требуется запущенный сервис Ollama с моделями `aya-expanse:8b` и `qwen3-vl:8b`.

1.  **Установите Ollama**: Следуйте инструкциям на [официальном сайте](https://ollama.com/).
2.  **Загрузите модели**:
    ```bash
    ollama pull aya-expanse:8b
    ollama pull qwen3-vl:8b
    ```
3.  **Настройте переменные окружения**:
    В `.env` или `docker-compose.yml` укажите `OLLAMA_BASE_URL`.
    Если Ollama запущена на хосте, используйте `http://host.docker.internal:11434` (для Docker Desktop) или IP адрес хоста.

    Убедитесь, что `MODERATION_CHANNEL_ID` указан в переменных окружения.

## Использование

### Команды

*   `/trigger <key>` - Запустить мастер создания триггера для указанной ключевой фразы.
*   `/list` - Показать список всех триггеров в текущем чате.
*   `/del <key>` - Удалить конкретный триггер по его ключевой фразе.
*   `/lang` - Изменить язык бота (Русский/Английский).
*   `/settings` - Открыть меню настроек (только для администраторов).

### Настройки

*   **Admins Only Add**: Переключить режим, когда только администраторы могут создавать триггеры.
*   **Clear All Triggers**: Удалить все триггеры в чате (требуется подтверждение).

## Разработка

*   **Язык**: Python 3.13+
*   **Фреймворк**: Aiogram 3.x
*   **База данных**: PostgreSQL + SQLAlchemy (Async)
*   **Кэш**: Valkey (Redis compatible)
*   **Линтинг**: Ruff
*   **Управление зависимостями**: uv

Для локального запуска без Docker (требуется запущенные экземпляры Postgres и Redis):
```bash
# Установка зависимостей
uv sync

# Запуск бота
uv run uvicorn app.main:app --reload
```
