# Trigger Bot

Telegram-бот для управления пользовательскими триггерами в чатах. Позволяет пользователям задавать ключевые фразы и соответствующие ответы (текст, изображения, стикеры и т.д.).

## Возможности

### Триггеры
*   **Создание триггеров**: Настройка триггеров с текстом, фото, стикерами, анимацией и т.д.
*   **Типы совпадений**: Точное совпадение, Содержит, Регулярное выражение.
*   **Контроль доступа**: Настройка того, кто может добавлять триггеры (все или только администраторы).
*   **Управление**: Список, удаление и управление триггерами через команды и инлайн-интерфейс.

### Модерация
*   **AI-модерация**: Автоматическая проверка контента с использованием Ollama (текст и изображения).
*   **Система варнов**: Предупреждения пользователей с настраиваемым лимитом.
*   **Мут/бан**: Ограничение и блокировка пользователей.
*   **Канал модерации**: Уведомления о нарушениях в отдельный чат.

### Капча
*   **Защита от ботов**: Проверка новых участников при входе в чат.
*   **Типы капчи**: Различные варианты проверки (текст, кнопки и др.).
*   **Автоудаление**: Кик пользователей, не прошедших проверку.

### Приветствия
*   **Кастомные сообщения**: Настраиваемые приветствия для новых участников.
*   **Шаблоны**: Переменные для имени пользователя, названия чата и т.д.

### Глобальный бан (GBan)
*   **Синхронизация**: Загрузка списка спамеров из внешнего источника (lols.bot).
*   **Автобан**: Автоматическая блокировка пользователей из списка.
*   **Включение/выключение**: Настройка для каждого чата отдельно.

### Система доверия (Trust)
*   **Уровни доверия**: Отслеживание репутации пользователей.
*   **История**: Журнал изменений уровня доверия.

### Прочее
*   **Интернационализация**: Поддержка нескольких языков (Английский, Русский).
*   **Кэширование**: Высокая производительность благодаря кэшированию Valkey (Redis).
*   **Переменные чата**: Хранение пользовательских переменных для каждого чата.
*   **Часовые пояса**: Настройка временной зоны для чата.
*   **Статистика**: Сбор и отображение статистики использования.

## Быстрый старт

### Требования

*   Docker и Docker Compose
*   Токен Telegram-бота (от @BotFather)
*   NVIDIA GPU (для модерации через Ollama)

### 1. Клонирование и настройка

```bash
git clone <repository_url>
cd trigger
cp .env.example .env
```

## Переменные окружения

### Обязательные

| Переменная | Описание |
| :--- | :--- |
| `BOT_TOKEN` | Токен Telegram-бота |
| `POSTGRES_URL` | Строка подключения к PostgreSQL |
| `VALKEY_URL` | Строка подключения к Valkey (Redis) |
| `WEBHOOK_URL` | Полный URL для вебхука |
| `WEBHOOK_PATH` | Путь для вебхука (например, `/webhook`) |
| `SECRET_TOKEN` | Секретный токен для защиты вебхука |
| `WEBAPP_URL` | URL веб-приложения (админка) |
| `MODERATION_CHANNEL_ID` | ID чата для уведомлений модерации |

### Опциональные

| Переменная | По умолчанию | Описание |
| :--- | :--- | :--- |
| `RABBITMQ_URL` | `amqp://guest:guest@rabbitmq:5672/` | Строка подключения к RabbitMQ |
| `TELEGRAM_BOT_API_URL` | `https://api.telegram.org` | URL Telegram Bot API (для локального сервера) |
| `OLLAMA_BASE_URL` | `http://localhost:11434` | URL сервера Ollama |
| `OLLAMA_VISION_MODEL` | `qwen3-vl:8b` | Модель для анализа изображений |
| `OLLAMA_TEXT_MODEL` | `aya-expanse:8b` | Модель для анализа текста |
| `BOT_ADMINS` | — | ID администраторов бота (через запятую) |
| `BOT_VERSION` | `unknown` | Версия бота |
| `BOT_TIMEZONE` | `Europe/Moscow` | Временная зона по умолчанию |
| `API_V1_STR` | `/api/v1` | Префикс API |
| `URL_PREFIX` | — | Префикс URL (для reverse proxy) |
| `GBAN_LIST_URL` | `https://lols.bot/spam/banlist.json` | URL списка глобальных банов |

### Переменные Docker Compose

| Переменная | Описание |
| :--- | :--- |
| `APP_IMAGE` | Docker-образ приложения |
| `POSTGRES_USER` | Пользователь PostgreSQL |
| `POSTGRES_PASSWORD` | Пароль PostgreSQL |
| `PROXY_PORT` | Порт прокси |
| `ROUTER_NAME` | Имя роутера (Traefik) |

### Frontend (веб-админка)

| Переменная | По умолчанию | Описание |
| :--- | :--- | :--- |
| `VITE_API_URL` | `/api/v1` | URL API для фронтенда |

## Веб-админка (Frontend)

Веб-интерфейс для управления ботом, расположен в директории `frontend/`.

### Функции

*   **Просмотр чатов**: Список всех чатов с ботом.
*   **Управление триггерами**: Просмотр и удаление триггеров.
*   **Пользователи**: Просмотр информации о пользователях.
*   **Капча**: Просмотр сессий капчи.
*   **Статистика**: Общая статистика использования.

### Технологии

*   React + TypeScript
*   Vite
*   TailwindCSS

### Запуск

```bash
cd frontend
npm install
npm run dev
```

### 2. Запуск Ollama (для модерации)

Создайте `docker-compose.ollama.yml`:

```yaml
services:
  ollama:
    image: ollama/ollama:latest
    container_name: ollama
    privileged: true
    restart: unless-stopped
    ports:
      - "11434:11434"
    volumes:
      - ollama_data:/root/.ollama
    environment:
      - OLLAMA_ORIGINS=*
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: ["gpu"]

volumes:
  ollama_data:
```

Запустите и установите модели:

```bash
docker compose -f docker-compose.ollama.yml up -d
docker exec -it ollama ollama pull aya-expanse:8b
docker exec -it ollama ollama pull qwen3-vl:8b
```

### 3. Запуск бота

```bash
docker compose up -d --build
```

## Использование

### Команды

*   `/trigger <key>` - Запустить мастер создания триггера для указанной ключевой фразы.
*   `/triggers` - Показать список всех триггеров в текущем чате.
*   `/del <key>` - Удалить конкретный триггер по его ключевой фразе.
*   `/lang` - Изменить язык бота (Русский/Английский).
*   `/settings` - Открыть меню настроек (только для администраторов).

### Настройки

*   **Admins Only Add**: Переключить режим, когда только администраторы могут создавать триггеры.
*   **Clear All Triggers**: Удалить все триггеры в чате (требуется подтверждение).

---

## Разработка

**Стек**: Python 3.13+, Aiogram 3.x, PostgreSQL, SQLAlchemy (Async), Valkey, Ruff, uv

Локальный запуск (требуется Postgres и Redis):

```bash
uv sync
uv run uvicorn app.main:app --reload
```
