# –¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –ó–∞–¥–∞–Ω–∏–µ: –°–∏—Å—Ç–µ–º–∞ –¥–æ–≤–µ—Ä–µ–Ω–Ω—ã—Ö —á–∞—Ç–æ–≤ –∏ —Ä–æ–ª–µ–π

## 1. –ò–µ—Ä–∞—Ä—Ö–∏—è —Ä–æ–ª–µ–π

–°–∏—Å—Ç–µ–º–∞ –¥–æ–ª–∂–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å —Å–ª–µ–¥—É—é—â—É—é –≤–µ—Ä—Ç–∏–∫–∞–ª—å –≤–ª–∞—Å—Ç–∏:

1.  **Super Admin (–í–ª–∞–¥–µ–ª–µ—Ü):**
    *   –ù–∞–∑–Ω–∞—á–∞–µ—Ç—Å—è **—Ç–æ–ª—å–∫–æ** —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è.
    *   –ò–º–µ–µ—Ç –ø–æ–ª–Ω—ã–µ –ø—Ä–∞–≤–∞.
    *   –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å—á–∏—Ç–∞–µ—Ç—Å—è *–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä–æ–º* –∏ *–î–æ–≤–µ—Ä–µ–Ω–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º*.
2.  **Bot Moderator (–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä –±–æ—Ç–∞):**
    *   –ù–∞–∑–Ω–∞—á–∞–µ—Ç—Å—è *–°—É–ø–µ—Ä-–∞–¥–º–∏–Ω–æ–º*.
    *   –ú–æ–∂–µ—Ç —É–ø—Ä–∞–≤–ª—è—Ç—å *–î–æ–≤–µ—Ä–µ–Ω–Ω—ã–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏*.
    *   –ú–æ–∂–µ—Ç —É–ø—Ä–∞–≤–ª—è—Ç—å —Ç—Ä–∏–≥–≥–µ—Ä–∞–º–∏ (–±–∞–Ω/—É–¥–∞–ª–µ–Ω–∏–µ) —á–µ—Ä–µ–∑ –∫–∞–Ω–∞–ª –º–æ–¥–µ—Ä–∞—Ü–∏–∏.
    *   –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å—á–∏—Ç–∞–µ—Ç—Å—è *–î–æ–≤–µ—Ä–µ–Ω–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º*.
3.  **Trusted User (–î–æ–≤–µ—Ä–µ–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å):**
    *   –ù–∞–∑–Ω–∞—á–∞–µ—Ç—Å—è *–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä–æ–º* –∏–ª–∏ *–ê–¥–º–∏–Ω–æ–º*.
    *   –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è: –µ–≥–æ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏–µ –¥–µ–ª–∞–µ—Ç —á–∞—Ç "–î–æ–≤–µ—Ä–µ–Ω–Ω—ã–º".
    *   –ï–≥–æ –ª–∏—á–Ω—ã–µ —Ç—Ä–∏–≥–≥–µ—Ä—ã –≤—Å–µ–≥–¥–∞ —Å—á–∏—Ç–∞—é—Ç—Å—è `safe`.

***

## 2. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∏ –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

### 2.1. `.env`
–î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –¥–ª—è —Å–ø–∏—Å–∫–∞ —Å—É–ø–µ—Ä-–∞–¥–º–∏–Ω–æ–≤:
*   `BOT_ADMINS`: –°–ø–∏—Å–æ–∫ ID —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é –∏–ª–∏ JSON-–º–∞—Å—Å–∏–≤.
    *   –ü—Ä–∏–º–µ—Ä: `BOT_ADMINS=12345678,87654321`

***

## 3. –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –ë–∞–∑–µ –î–∞–Ω–Ω—ã—Ö

### 3.1. –¢–∞–±–ª–∏—Ü–∞ `users` (–ú–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è)
–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–æ–ª–µ–π.
*   `is_bot_moderator` (Boolean, Default: False): –Ø–≤–ª—è–µ—Ç—Å—è –ª–∏ –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–æ–º –±–æ—Ç–∞.
*   `is_trusted` (Boolean, Default: False): –Ø–≤–ª—è–µ—Ç—Å—è –ª–∏ –¥–æ–≤–µ—Ä–µ–Ω–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º.

### 3.2. –¢–∞–±–ª–∏—Ü–∞ `chats` (–ú–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è)
*   `is_trusted` (Boolean, Default: False): –§–ª–∞–≥ –¥–æ–≤–µ—Ä–µ–Ω–Ω–æ–≥–æ —á–∞—Ç–∞.

### 3.3. –ù–æ–≤–∞—è —Ç–∞–±–ª–∏—Ü–∞ `chat_trust_history` (–ò—Å—Ç–æ—Ä–∏—è –¥–æ–≤–µ—Ä–∏—è)
–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å, –∫—Ç–æ –∏ –∫–æ–≥–¥–∞ —Å–¥–µ–ª–∞–ª —á–∞—Ç –¥–æ–≤–µ—Ä–µ–Ω–Ω—ã–º.

| –ü–æ–ª–µ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
| :--- | :--- | :--- |
| `id` | Integer (PK) | ID –∑–∞–ø–∏—Å–∏. |
| `chat_id` | BigInteger | –°—Å—ã–ª–∫–∞ –Ω–∞ —á–∞—Ç. |
| `user_id` | BigInteger | –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, —á—å–µ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏–µ/–¥–µ–π—Å—Ç–≤–∏–µ —Å–¥–µ–ª–∞–ª–æ —á–∞—Ç –¥–æ–≤–µ—Ä–µ–Ω–Ω—ã–º. |
| `event_type` | Enum/String | `'granted'` (—Å—Ç–∞—Ç—É—Å –ø–æ–ª—É—á–µ–Ω), `'revoked'` (—Å—Ç–∞—Ç—É—Å —Å–Ω—è—Ç). |
| `created_at` | DateTime | –î–∞—Ç–∞ —Å–æ–±—ã—Ç–∏—è. |

***

## 4. –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞

### 4.1. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–æ–ª—è–º–∏ (–ö–æ–º–∞–Ω–¥—ã)
–≠—Ç–∏ –∫–æ–º–∞–Ω–¥—ã —Ä–∞–±–æ—Ç–∞—é—Ç —Ç–æ–ª—å–∫–æ –≤ –ª–∏—á–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö –±–æ—Ç—É –∏–ª–∏ –≤ —á–∞—Ç–∞—Ö, –Ω–æ –¥–æ—Å—Ç—É–ø–Ω—ã —Ç–æ–ª—å–∫–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–º —Ä–æ–ª—è–º.

1.  **/add_mod `<id|username>`**
    *   *–î–æ—Å—Ç—É–ø:* –¢–æ–ª—å–∫–æ `BOT_ADMINS`.
    *   *–î–µ–π—Å—Ç–≤–∏–µ:* –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç `is_bot_moderator = True`.
2.  **/del_mod `<id|username>`**
    *   *–î–æ—Å—Ç—É–ø:* –¢–æ–ª—å–∫–æ `BOT_ADMINS`.
    *   *–î–µ–π—Å—Ç–≤–∏–µ:* –°–Ω–∏–º–∞–µ—Ç –ø—Ä–∞–≤–∞ –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–∞.
3.  **/trust `<id|username>`**
    *   *–î–æ—Å—Ç—É–ø:* `BOT_ADMINS` –∏ `is_bot_moderator`.
    *   *–î–µ–π—Å—Ç–≤–∏–µ:* –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç `is_trusted = True`.
4.  **/untrust `<id|username>`**
    *   *–î–æ—Å—Ç—É–ø:* `BOT_ADMINS` –∏ `is_bot_moderator`.
    *   *–î–µ–π—Å—Ç–≤–∏–µ:* –°–Ω–∏–º–∞–µ—Ç —Å—Ç–∞—Ç—É—Å –¥–æ–≤–µ—Ä–µ–Ω–Ω–æ–≥–æ.

### 4.2. –õ–æ–≥–∏–∫–∞ "–î–æ–≤–µ—Ä–µ–Ω–Ω–æ–≥–æ —á–∞—Ç–∞" (Trust Inheritance)
–ß–∞—Ç —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –¥–æ–≤–µ—Ä–µ–Ω–Ω—ã–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, –µ—Å–ª–∏ –≤ –Ω–µ–º –ø—Ä–æ—è–≤–ª—è–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–æ–≤–µ—Ä–µ–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å.

**–ú–µ—Ö–∞–Ω–∏–∑–º (Middleware):**
1.  –ü—Ä–∏ –∫–∞–∂–¥–æ–º –≤—Ö–æ–¥—è—â–µ–º —Å–æ–æ–±—â–µ–Ω–∏–∏ (–∏–ª–∏ —Ö–æ—Ç—è –±—ã –ø—Ä–∏ –∫–æ–º–∞–Ω–¥–∞—Ö/—Å–æ–∑–¥–∞–Ω–∏–∏ —Ç—Ä–∏–≥–≥–µ—Ä–∞) –ø—Ä–æ–≤–µ—Ä—è—Ç—å —Å—Ç–∞—Ç—É—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è-–æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è.
2.  **–£—Å–ª–æ–≤–∏–µ:**
    *   –ï—Å–ª–∏ `user.is_trusted` (–∏–ª–∏ Admin/Mod) == `True`.
    *   –ò `chat.is_trusted` == `False`.
    *   –ò —Ç–∏–ø —á–∞—Ç–∞ ‚Äî –≥—Ä—É–ø–ø–∞/—Å—É–ø–µ—Ä–≥—Ä—É–ø–ø–∞.
3.  **–î–µ–π—Å—Ç–≤–∏–µ:**
    *   `UPDATE chats SET is_trusted = True WHERE id = ...`
    *   `INSERT INTO chat_trust_history (...) VALUES (chat_id, user_id, 'granted', now())`
    *   –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç: "–ß–∞—Ç X —Å—Ç–∞–ª –¥–æ–≤–µ—Ä–µ–Ω–Ω—ã–º –±–ª–∞–≥–æ–¥–∞—Ä—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é Y".

**–†—É—á–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
–î–æ–±–∞–≤–∏—Ç—å –∞–¥–º–∏–Ω–∞–º –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –≤—Ä—É—á–Ω—É—é —Å–Ω–∏–º–∞—Ç—å —Å—Ç–∞—Ç—É—Å –¥–æ–≤–µ—Ä–µ–Ω–Ω–æ–≥–æ —Å —á–∞—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –µ—Å–ª–∏ –¥–æ–≤–µ—Ä–µ–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞—á–∞–ª —Ö—É–ª–∏–≥–∞–Ω–∏—Ç—å –≤ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º —á–∞—Ç–µ), –Ω–æ —Å–∏—Å—Ç–µ–º–∞ –º–æ–∂–µ—Ç —Å–Ω–æ–≤–∞ –≤—ã–¥–∞—Ç—å —Å—Ç–∞—Ç—É—Å –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏.

### 4.3. –û–±—Ö–æ–¥ AI-–º–æ–¥–µ—Ä–∞—Ü–∏–∏
–ò–∑–º–µ–Ω–∏—Ç—å –ª–æ–≥–∏–∫—É —Å–æ–∑–¥–∞–Ω–∏—è —Ç—Ä–∏–≥–≥–µ—Ä–∞ (`/add`) –∏ –ª–æ–≥–∏–∫—É AI-–≤–æ—Ä–∫–µ—Ä–∞.

**–ê–ª–≥–æ—Ä–∏—Ç–º –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ç—Ä–∏–≥–≥–µ—Ä–∞:**

1.  **–ü—Ä–æ–≤–µ—Ä–∫–∞ 1 (–ß–∞—Ç):** –ï—Å–ª–∏ `chat.is_trusted == True` ‚Üí –°—Ç–∞—Ç—É—Å —Ç—Ä–∏–≥–≥–µ—Ä–∞ —Å—Ä–∞–∑—É `safe` (–±–µ–∑ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ RabbitMQ).
2.  **–ü—Ä–æ–≤–µ—Ä–∫–∞ 2 (–°–æ–∑–¥–∞—Ç–µ–ª—å):** –ï—Å–ª–∏ `user.is_trusted` (–∏–ª–∏ Admin/Mod) == `True` ‚Üí –°—Ç–∞—Ç—É—Å —Ç—Ä–∏–≥–≥–µ—Ä–∞ —Å—Ä–∞–∑—É `safe`.
3.  **–ò–Ω–∞—á–µ:** –°—Ç–∞—Ç—É—Å `pending` ‚Üí –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ RabbitMQ –Ω–∞ AI-–º–æ–¥–µ—Ä–∞—Ü–∏—é.

### 4.4. –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è
*   –í –∫–æ–º–∞–Ω–¥–µ `/settings` –¥–æ–±–∞–≤–∏—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä: "üõ° –ß–∞—Ç —è–≤–ª—è–µ—Ç—Å—è –¥–æ–≤–µ—Ä–µ–Ω–Ω—ã–º".

***

## 5. –ü–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

1.  **Config:** –û–±–Ω–æ–≤–∏—Ç—å –ø–∞—Ä—Å–∏–Ω–≥ `.env` (–¥–æ–±–∞–≤–∏—Ç—å `BOT_ADMINS`).
2.  **DB Migration:**
    *   –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—è `is_bot_moderator`, `is_trusted` –≤ `users`.
    *   –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ `is_trusted` –≤ `chats`.
    *   –°–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É `chat_trust_history`.
3.  **Middleware:**
    *   –û–±–Ω–æ–≤–∏—Ç—å middleware –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: `Super Admin` –≤—Å–µ–≥–¥–∞ –∏–º–µ–µ—Ç –ø—Ä–∞–≤–∞ `Moderator` –∏ `Trusted`.
    *   –ù–∞–ø–∏—Å–∞—Ç—å `TrustMiddleware`: –ø—Ä–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –¥–æ–≤–µ—Ä–µ–Ω–Ω–æ–≥–æ —é–∑–µ—Ä–∞ –∞–ø–¥–µ–π—Ç–∏—Ç—å —Å—Ç–∞—Ç—É—Å —á–∞—Ç–∞ –∏ –ø–∏—Å–∞—Ç—å –ª–æ–≥ –≤ –∏—Å—Ç–æ—Ä–∏—é.
4.  **Handlers:**
    *   –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∞–¥–º–∏–Ω—Å–∫–∏–µ –∫–æ–º–∞–Ω–¥—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–æ–ª—è–º–∏ (`/trust`, `/add_mod` –∏ —Ç.–¥.).
5.  **Moderation Logic:**
    *   –í —Ö–µ–Ω–¥–ª–µ—Ä–µ `/add` –¥–æ–±–∞–≤–∏—Ç—å `if is_trusted: skip_ai()`.
