# =============================================================================
# Trigger Bot - GitLab CI/CD Pipeline
# =============================================================================
# This pipeline provides:
# - Code validation (lint, format, type checking)
# - Security scanning (secrets, dependencies, containers)
# - Docker image building with caching
# - Multi-environment deployment (test, production)
# - Health checks and notifications
# =============================================================================

include:
  # - local: '.gitlab/ci/templates/.test.yml'
  # - local: '.gitlab/ci/templates/.security.yml'
  - local: '.gitlab/ci/templates/.build.yml'
  - local: '.gitlab/ci/templates/.deploy.yml'

stages:
  # - validate
  # - test
  - build
  # - verify
  - deploy

variables:
  DOCKER_BUILDKIT: "1"
  COMPOSE_DOCKER_CLI_BUILD: "1"

  IMAGE_TAG_TEST: $CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA
  IMAGE_TAG_TEST_FLOATING: $CI_REGISTRY_IMAGE:test
  IMAGE_TAG_PROD: $CI_REGISTRY_IMAGE:$CI_COMMIT_TAG
  IMAGE_TAG_LATEST: $CI_REGISTRY_IMAGE:latest

  HEALTH_CHECK_TIMEOUT: "60"
  DEPLOY_TIMEOUT: "300"

default:
  retry:
    max: 2
    when:
      - runner_system_failure
      - stuck_or_timeout_failure

workflow:
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "master" && $CI_PIPELINE_SOURCE == "push"
    - if: $CI_COMMIT_TAG
    - if: $CI_PIPELINE_SOURCE == "web"
